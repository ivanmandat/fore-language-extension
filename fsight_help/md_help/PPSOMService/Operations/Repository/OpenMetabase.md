# OpenMetabase: Операция

OpenMetabase: Операция
-


# OpenMetabase


## Синтаксис


OpenMetabaseResult OpenMetabase(MbDef tDef, UserCreds
 tCreds, [OpenMetabaseArg tArg])


## Параметры


tDef. Описание
 репозитория, к которому осуществляется подключение.


tCreds. Параметры аутентификации
 пользователя.


tArg. Параметры подключения.


## Описание


Операция OpenMetabase осуществляет
 подключение к репозиторию и возвращает моникёр соединения с репозиторием.


## Комментарии


Операция позволяет выполнить следующие действия:


	- подключиться к существующему репозиторию и получить доступ к
	 его объектам;


	- создать новый репозиторий на сервере СУБД.


Подключение к репозиторию может осуществляться различными способами.
 Для подключения необходимо указать информацию о репозитории и параметры
 аутентификации пользователя. Для указания репозитория, к которому осуществляется
 подключение, доступны следующие варианты:


	- В поле tDef.id укажите
	 идентификатор описания репозитория. При выполнении операции в реестре
	 операционной системы сервера, на котором расположен BI-сервер, производится
	 поиск указанного описания. Если описание найдено, то его настройки
	 будут использованы для подключения к репозиторию.


	- В поле tDef.logonData
	 укажите параметры модуля безопасности, необходимые для подключения
	 к репозиторию (драйвер СУБД, используемый для подключения, наименование
	 или IP-адрес сервера, идентификатор схемы/базы данных). При этом в
	 качестве идентификатора описания в поле tDef.id
	 должна быть указана пустая строка.


Также, с помощью операции OpenMetabase может быть создано гостевое соединение.
 Более подробно читайте в статье «[Использование
 гостевого подключения](../../Intro/UseGuestConnection.htm)».


Для аутентификации пользователей доступны следующие способы (более подробное
 описание представлено ниже):


	- С прямым указанием учётных данных;


	- С аутентификацией доменного пользователя;


	- С использованием протокола OAuth;


	- С использованием цифровой подписи.


Параметры аутентификации указываются в поле tCreds.


Результатом выполнения операции будут:


	- моникёр соединения с репозиторием (поле id);


	- ключ сессии (поле sessKey);


	- идентификатор сессии (поле sessCookie);


	- версия репозитория (поле version).


Примечание.
 Параметры сессии хранятся в памяти BI-сервера или на сервере состояний,
 если в [конфигурации](Setup.chm::/UiWebSetup/03_Setup_Web/BI_Server_Registry_Key.htm)
 определена группа настроек StateServer.
 Если группа настроек StateServer
 определена, но сам сервер состояний отключен, то идентификатор сессии
 сгенерирован не будет.


Полученный моникёр в дальнейшем будет использоваться в следующих случаях:


	- при выполнении различных операций для указания репозитория,
	 в рамках которого осуществляется работа;


	- в поле id при формировании
	 идентификатора объекта, с которым осуществляется работа;


	- при закрытии соединения с репозиторием с помощью операции [CloseMetabase](CloseMetabase.htm).


Ключ сессии sessKey
 может использоваться, например, при работе с [протоколом
 доступа](OpenAuditLog.htm) для получения списка операций, выполненных в рамках сессии.


Идентификатор sessCookie, в
 отличие от моникёра, не используется для работы с репозиторием, а используется
 только для идентификации существующих сессий на сервере. Если полученный
 идентификатор сохранить и в дальнейшем, при новом подключении, указать
 в качестве значения поля tArg.sessCookie,
 то на BI-сервере будет осуществлена проверка на наличие сессии с таким
 же идентификатором. Если сессия существует, то будет осуществлена проверка
 на возможность её повторного использования. Необходимыми условиями для
 повторного использования сессии являются:


	- корректные логин и пароль пользователя;


	- среди активных сессий ещё существует сессия с указанным идентификатором;


	- существующая сессия была создана именно для указанного пользователя.


## Способы аутентификации


В зависимости от выбранного типа аутентификации будут использоваться
 различные поля операции OpenMetabase. Также могут потребоваться дополнительные
 настройки, представленные ниже.


	Учётные данные
	 Интегрированная доменная аутентификация
	 OAuth Цифровая подпись


		Для подключения с прямой передачей учётных данных укажите имя пользователя
		 и пароль в полях tCreds.user
		 и tCreds.pass соответственно.


		Для использования интегрированной доменной аутентификации пользователя
		 поле tCreds.user не указывается,
		 а в поле tCreds.pass
		 необходимо указать пустое значение. При этом для подключения будут
		 переданы учётные данные текущего пользователя операционной системы.


		Для подключения с использованием протокола OAuth необходимо предварительно
		 подготовить репозиторий следующим образом:


			- в [реестре](Setup.chm::/UiWebSetup/03_Setup_Web/BI_Server_Registry_Key.htm#oauth)/[файле
			 settings.xml](Setup.chm::/UiWebSetup/03_Setup_Web/BI_Server_Settings_XML.htm#system) создайте раздел OAuth, внутри
			 него создайте подраздел и задайте настройки, необходимые для
			 работы с внешним сервером аутентификации по протоколу [OAuth
			 2.0](../../../Setup/UiWebSetup/Authentication/login_settings_using_external_services.htm).


			- в файле [Metabases.xml](Setup.chm::/06_AK_Client_Config/Configuring_repository_list_in_the_system_registry.htm)
			 создайте раздел для подключения к репозиторию, в качестве
			 значения атрибута Authentication укажите значение 7. Внутри
			 созданного раздела создайте подраздел OAuthService, в атрибуте
			 Providers укажите наименование сервера аутентификации, которое
			 было задано в [реестре](Setup.chm::/UiWebSetup/03_Setup_Web/BI_Server_Registry_Key.htm#oauth)/[файле
			 settings.xml](Setup.chm::/UiWebSetup/03_Setup_Web/BI_Server_Settings_XML.htm#system).


		Подключение выполняется в несколько этапов с выполнением дополнительных
		 операций:


			- Выполните операцию [GetOAuthSettings](GetOAuthSettings.htm),
			 в поле svcKey укажите
			 значение -1. В результате операции будет получен список серверов
			 аутентификации, созданных в разделе OAuth в [реестре](Setup.chm::/UiWebSetup/03_Setup_Web/BI_Server_Registry_Key.htm#oauth)/[файле
			 settings.xml](Setup.chm::/UiWebSetup/03_Setup_Web/BI_Server_Settings_XML.htm#system). Для каждого элемента списка
			 будет доступен идентификатор, ключ и пиктограмма - поля id, key
			 и icon соответственно.


			- Выполните операцию [CreateOAuthState](CreateOAuthState.htm),
			 в поле svcKey укажите
			 ключ настроек одного из полученных серверов аутентификации.
			 Во время выполнения операции BI-сервер сгенерирует параметр
			 state для защиты
			 от потенциальных атак типа CSRF при получении кода авторизации.
			 В результате операции в поле authUrl
			 будет URL-адрес сервиса аутентификации, дополненный параметром
			 state. Значение адреса
			 формируется на основании настроек, заданных в [реестре](Setup.chm::/UiWebSetup/03_Setup_Web/BI_Server_Registry_Key.htm#oauth)/[файле
			 settings.xml](Setup.chm::/UiWebSetup/03_Setup_Web/BI_Server_Settings_XML.htm#system), должно содержать параметр
			 redirect_uri. Адрес,
			 указанный в redirect_uri,
			 должен быть прописан в настройках внешнего сервиса аутентификации.
			 Также в ответе через заголовок Set-Cookie BI-сервер устанавливает
			 в браузере cookie со значением параметра state.
			 Cookie имеет время жизни 5 минут, имеет атрибуты HttpOnly
			 и Secure.


		Важно.
		 Cookie с атрибутом Secure передаются только по HTTPS-соединению,
		 поэтому взаимодействие BI-сервера и веб-приложения обязательно
		 должны быть настроены на [работу
		 по HTTPS](Setup.chm::/UiWebSetup/04_FAQ/setting_https.htm), иначе OAuth-аутентификация будет
		 невозможна.


			- Веб-приложение должно осуществить перенаправление по
			 полученному адресу authUrl.
			 Пользователь проходит аутентификацию на внешнем сервисе. При
			 успешной аутентификации внешний сервис осуществляет обратное
			 перенаправление в веб-приложение по адресу, который был задан
			 в параметре redirect_uri
			 с указанием параметров code
			 и state.


			- Выполните операцию [GetOAuthToken](GetOAuthToken.htm),
			 в поле svcKey укажите
			 использованный ранее ключ настроек сервера аутентификации,
			 в поле applicationUrl
			 укажите значение параметра redirect_uri,
			 в полях loginCode
			 и state значения
			 полученных параметров code
			 и state соответственно.
			 При выполнении BI-сервер по значению параметра state
			 осуществит проверку происхождения запроса и обратится
			 к внешнему серверу аутентификации для формирования токена.
			 Если все завершилось успешно, то полученный токен будет доступен
			 в поле oauth_token
			 результата выполнения операции.


			- Выполните операцию OpenMetabase с указанием дочерних
			 полей для поля tCreds.oauth:
			 в oauth_token укажите
			 полученный на шаге 4 токен, в поле oauth_verifier
			 укажите пустое значение, а в поле svcKey
			 ключ настроек сервера аутентификации. В поле tCreds.pass
			 также укажите пустое значение.


		При успешном выполнении всех действий будет осуществлено подключение
		 к репозиторию.


		Для подключения с использованием цифровой подписи необходимо предварительно
		 подготовить репозиторий следующим образом:


			- в реестре необходимо сохранить зашифрованный пароль,
			 который будет использоваться для подключения к базе данных
			 репозитория. Для этого запустите утилиту [PP.Util](Setup.chm::/05_RepoMngr/Service_Applications/PP_Util.htm)
			 с ключом /save_creds
			 <ID описания репозитория>
			 <имя пользователя>. Утилита расположена в папке
			 с установленным «Форсайт. Аналитическая платформа».
			 После успешного запуска будет запрошен пароль. Введите пароль.
			 После этого будет выведено сообщение «Password for metabase
			 “ID описания репозитория” and login “имя пользователя” saved»;


			- сохраните сертификат в репозиторий используя следующую
			 команду: PP.Util.exe
			 /save_cert "путь
			 до сертификата" <ID описания репозитория> <имя
			 пользователя>. После этого утилита запросит пароль
			 указанного пользователя. Полученные учётные данные будут использованы
			 для подключения к репозиторию. При удачной авторизации и сохранении
			 сертификата будет выведено сообщение: Certificate from file
			 "путь до сертификата" with identifier "ID сертификата"
			 saved to metabase "ID описания репозитория";


			- сохранить закрытый ключ в реестре используя следующую
			 команду: PP.Util.exe /save_private_key
			 "путь до ключа"
			 <ID сертификата> <алгоритм шифрования := gos|pro,
			 если не указан, то gos>. После удачного сохранения
			 закрытого ключа будет выведено сообщение: "Certificate
			 from file "путь до ключа" with identifier "ID
			 сертификата" saved".


		Примечание.
		 Если BI-сервер установлен на веб-сервере IIS, то пул BI-сервера
		 должен быть запущен из-под того пользователя, под которым запускали
		 утилиту PP.Util.


		Перед подключением необходимо выполнить операцию [GetVerifierCode](GetVerifierCode.htm) для получения
		 блока данных, которые клиент должен будет подписать цифровой подписью.
		 Подписанные данные необходимо указать в поле tCreds.verifier.signature,
		 в поле tCreds.verifier.cookie
		 необходимо указать случайное число, которое также будет получено
		 в результате выполнения операции [GetVerifierCode](GetVerifierCode.htm).
		 В поле tCreds.verifier.user
		 указывается пользователь, под которым осуществляется подключение.
		 Этот пользователь может отсутствовать в СУБД репозитория и менеджере
		 безопасности.


		Примечание.
		 Если указан пользователь, который отсутствует везде, то он будет
		 создан в менеджере безопасности репозитория. Если было задано
		 поле tCreds.verifier.role,
		 то пользователь будет включен в указанную группу и будет обладать
		 соответствующими правами. Если поле не задано, то пользователь
		 будет включен во встроенную группу ПОЛЬЗОВАТЕЛИ. При необходимости
		 права созданного пользователя можно изменить с помощью операции
		 [SetMbSec](SetMbSec.htm).


		В поле tCreds.verifier.mbUser
		 укажите пользователя, под которым будет осуществляться фактическое
		 подключение к базе данных репозитория. Данный пользователь должен
		 существовать в СУБД и обладать правами на вход в репозиторий.
		 Также в поле tCreds.verifier.certificate
		 необходимо указать идентификатор сертификата, который будет использоваться
		 для проверки цифровой подписи. Данный сертификат должен быть сохранён
		 в репозитории таким образом, как это было описано выше. В поле
		 tCreds.pass задается
		 пустая строка, данное поле не используется при подключении с использованием
		 цифровой подписи.


## Отслеживание событий


В репозитории может быть установлен обработчик пользовательских событий,
 который будет обрабатывать действия, выполняемые из веб-сервиса. Для этого
 необходимо задать следующие настройки:


	- Свойству [IMetabaseDefinition.CheckCustomEvents](KeSom.chm::/Interface/IMetabaseDefinition/IMetabaseDefinition.CheckCustomEvents.htm)
	 установить значение True.


	- Для репозитория установить [специальный
	 объект](KeSom.chm::/Interface/IMetabase/IMetabase.SpecialObject.htm) [MetabaseSpecialObject.MetabaseCustomEvents](KeSom.chm::/Enums/MetabaseSpecialObject.htm),
	 в качестве объекта указывается модуль, содержащий реализацию интерфейса
	 [IMetabaseCustomEvents](KeSom.chm::/Interface/IMetabaseCustomEvents/IMetabaseCustomEvents.htm).


При выполнении операции OpenMetabase
 будет выполнен следующий алгоритм:


	- Если [IMetabaseDefinition.CheckCustomEvents](KeSom.chm::/Interface/IMetabaseDefinition/IMetabaseDefinition.CheckCustomEvents.htm)
	 = False, то открывается соединение
	 в соответствии с переданными учётными данными и возвращается моникёр
	 соединения.


	- Если [IMetabaseDefinition.CheckCustomEvents](KeSom.chm::/Interface/IMetabaseDefinition/IMetabaseDefinition.CheckCustomEvents.htm)
	 = True, то открывается соединение
	 с учётными данными, которые должны быть сохранены утилитой [PP.Util](Setup.chm::/05_RepoMngr/Service_Applications/PP_Util.htm).
	 Если сохранённые учётные данные отсутствуют, то генерируется исключительная
	 ситуация.


	- Запускается на выполнение специальный объект, который должен
	 быть задан в репозитории. Если он не задан или в нём отсутствует реализация
	 интерфейса [IMetabaseCustomEvents](KeSom.chm::/Interface/IMetabaseCustomEvents/IMetabaseCustomEvents.htm),
	 то генерируется исключительная ситуация.


	- В событие [OnBeforeLogon](KeSom.chm::/Interface/IMetabaseCustomEvents/IMetabaseCustomEvents.OnBeforeLogon.htm) передаются
	 учётные данные, которые были переданы в операцию OpenMetabase. Далее,
	 в соответствии с прикладной логикой, в обработчике события можно произвести
	 какие-либо действия. Результирующее соединение должно быть задано
	 в свойстве [ResultMetabase](KeSom.chm::/Interface/IMetabaseOnBeforeLogonArgs/IMetabaseOnBeforeLogonArgs.ResultMetabase.htm) аргумента
	 события, моникёр этого соединения будет возвращён в результате операции.
	 Если по каким-либо причинам в обработчике события свойству [AllowLogon](KeSom.chm::/Interface/IMetabaseOnBeforeLogonArgs/IMetabaseOnBeforeLogonArgs.AllowLogon.htm) аргумента
	 события было установлено значение False,
	 то в результате операции будет сгенерирована исключительная ситуация.


## Пример


Различные варианты использования операции приведены в следующих примерах:


		 Наименование примера


		 [Подключение
		 к репозиторию с прямой передачей учётных данных](OpenMetabase_Sample/OpenMetabase_Sample.htm)


		 [Подключение
		 к репозиторию с использованием цифровой подписи](OpenMetabase_Sample/OpenMetabase_Sample1.htm)


		 [Подключение
		 к репозиторию с использованием интегрированной доменной аутентификации](OpenMetabase_Sample/OpenMetabase_Sample2.htm)


		 [Подключение
		 к репозиторию с аутентификацией на внешнем OAuth-сервере](OpenMetabase_Sample/OpenMetabase_Sample3.htm)


См. также:


[Общие
 операции](Repository_List.htm) | [Использование
 гостевого подключения](../../Intro/UseGuestConnection.htm)


		Справочная
		 система на версию 10.9
		 от 18/08/2025,
		 © ООО «ФОРСАЙТ»,
